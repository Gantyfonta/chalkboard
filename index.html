<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Multiplayer Chalkboard</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
    }
    canvas {
      display: block;
      background: black;
      cursor: crosshair;
    }
  </style>
</head>
<body>
<canvas id="chalkboard"></canvas>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
  import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAeBlNLDMLmMvsfcTF5ZvEOnHdTdLeH9oQ",
    authDomain: "chalkboard-fd511.firebaseapp.com",
    databaseURL: "https://chalkboard-fd511-default-rtdb.firebaseio.com",
    projectId: "chalkboard-fd511",
    storageBucket: "chalkboard-fd511.appspot.com",
    messagingSenderId: "314025498738",
    appId: "1:314025498738:web:6c84fd27c512008a048aeb",
    measurementId: "G-9WJ3B7SFRV"
  };

  // Init Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // Anonymous auth
  signInAnonymously(auth).catch(err => console.error("Auth error:", err));

  // Canvas setup
  const canvas = document.getElementById("chalkboard");
  const ctx = canvas.getContext("2d");

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  // Random color per user
  const color = `hsl(${Math.floor(Math.random() * 360)}, 100%, 50%)`;
  ctx.lineWidth = 3;
  ctx.lineCap = "round";

  // Mouse position helper
  function getMousePos(evt) {
    const rect = canvas.getBoundingClientRect();
    return {
      x: (evt.clientX - rect.left) * (canvas.width / rect.width),
      y: (evt.clientY - rect.top) * (canvas.height / rect.height)
    };
  }

  // Drawing logic
  let drawing = false;
  let lastPos = null;

  canvas.addEventListener("mousedown", e => {
    drawing = true;
    lastPos = getMousePos(e);
  });

  canvas.addEventListener("mousemove", e => {
    if (!drawing) return;
    const pos = getMousePos(e);
    drawLine(lastPos.x, lastPos.y, pos.x, pos.y, color);
    sendStroke(lastPos, pos, color);
    lastPos = pos;
  });

  canvas.addEventListener("mouseup", () => {
    drawing = false;
    lastPos = null;
  });

  // Draw locally
  function drawLine(x1, y1, x2, y2, c) {
    ctx.strokeStyle = c;
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
  }

  // Send stroke to Firebase
  function sendStroke(from, to, c) {
    push(ref(db, "strokes"), {
      x1: from.x, y1: from.y,
      x2: to.x, y2: to.y,
      color: c
    }).catch(err => console.error("push error", err));
  }

  // Listen for new strokes
  onChildAdded(ref(db, "strokes"), snapshot => {
    const s = snapshot.val();
    drawLine(s.x1, s.y1, s.x2, s.y2, s.color);
  });

</script>
</body>
</html>
