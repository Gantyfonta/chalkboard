<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Multiplayer Chalkboard</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
      color: white;
      font-family: sans-serif;
    }
    #chalkboard {
      display: block;
      background: black;
      cursor: crosshair;
    }
    #ui {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 10;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    button {
      background: #222;
      color: white;
      border: 1px solid #555;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #444;
    }
  </style>
</head>
<body>
<div id="ui">
  <button id="clearBtn">Clear Board</button>
  <span id="online">Online: 0</span>
</div>
<canvas id="chalkboard"></canvas>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
  import { getDatabase, ref, push, onChildAdded, onValue, set, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAeBlNLDMLmMvsfcTF5ZvEOnHdTdLeH9oQ",
    authDomain: "chalkboard-fd511.firebaseapp.com",
    databaseURL: "https://chalkboard-fd511-default-rtdb.firebaseio.com",
    projectId: "chalkboard-fd511",
    storageBucket: "chalkboard-fd511.appspot.com",
    messagingSenderId: "314025498738",
    appId: "1:314025498738:web:6c84fd27c512008a048aeb",
    measurementId: "G-9WJ3B7SFRV"
  };

  // Init Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // Sign in anonymously
  signInAnonymously(auth).catch(err => console.error("Auth error:", err));

  // Canvas setup
  const canvas = document.getElementById("chalkboard");
  const ctx = canvas.getContext("2d");

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  // Random color per user
  const color = `hsl(${Math.floor(Math.random() * 360)}, 100%, 50%)`;
  ctx.lineWidth = 3;
  ctx.lineCap = "round";

  // Mouse/touch position helper
  function getPos(evt) {
    const rect = canvas.getBoundingClientRect();
    if (evt.touches && evt.touches[0]) {
      return {
        x: (evt.touches[0].clientX - rect.left) * (canvas.width / rect.width),
        y: (evt.touches[0].clientY - rect.top) * (canvas.height / rect.height)
      };
    } else {
      return {
        x: (evt.clientX - rect.left) * (canvas.width / rect.width),
        y: (evt.clientY - rect.top) * (canvas.height / rect.height)
      };
    }
  }

  // Drawing logic
  let drawing = false;
  let lastPos = null;

  function startDraw(e) {
    e.preventDefault();
    drawing = true;
    lastPos = getPos(e);
  }

  function moveDraw(e) {
    if (!drawing) return;
    e.preventDefault();
    const pos = getPos(e);
    drawLine(lastPos.x, lastPos.y, pos.x, pos.y, color);
    sendStroke(lastPos, pos, color);
    lastPos = pos;
  }

  function endDraw(e) {
    e.preventDefault();
    drawing = false;
    lastPos = null;
  }

  // Mouse events
  canvas.addEventListener("mousedown", startDraw);
  canvas.addEventListener("mousemove", moveDraw);
  canvas.addEventListener("mouseup", endDraw);
  canvas.addEventListener("mouseleave", endDraw);

  // Touch events
  canvas.addEventListener("touchstart", startDraw, { passive: false });
  canvas.addEventListener("touchmove", moveDraw, { passive: false });
  canvas.addEventListener("touchend", endDraw, { passive: false });
  canvas.addEventListener("touchcancel", endDraw, { passive: false });

  // Draw locally
  function drawLine(x1, y1, x2, y2, c) {
    ctx.strokeStyle = c;
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
  }

  // Send stroke to Firebase
  function sendStroke(from, to, c) {
    push(ref(db, "strokes"), {
      x1: from.x, y1: from.y,
      x2: to.x, y2: to.y,
      color: c
    }).catch(err => console.error("push error", err));
  }

  // Listen for new strokes
  onChildAdded(ref(db, "strokes"), snapshot => {
    const s = snapshot.val();
    drawLine(s.x1, s.y1, s.x2, s.y2, s.color);
  });

  // Clear board (shared)
  const clearBtn = document.getElementById("clearBtn");
  clearBtn.addEventListener("click", () => {
    set(ref(db, "strokes"), null); // remove all strokes
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  });

  // Clear local canvas when board is cleared by someone
  onValue(ref(db, "strokes"), snapshot => {
    if (!snapshot.exists()) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  });

  // Track online users
  const onlineRef = ref(db, "online");
  const myRef = push(onlineRef);

  set(myRef, { active: true, ts: serverTimestamp() });
  window.addEventListener("beforeunload", () => {
    remove(myRef);
  });

  const onlineSpan = document.getElementById("online");
  onValue(onlineRef, snapshot => {
    const val = snapshot.val();
    onlineSpan.textContent = "Online: " + (val ? Object.keys(val).length : 0);
  });
</script>
</body>
</html>
